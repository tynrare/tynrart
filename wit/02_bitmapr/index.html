<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta name="viewport" content="width=device-width, minimal-ui, viewport-fit=cover, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
        <link rel="icon" type="image/png" href="./tile.png" />

        <title>Skeletonbros â€¢ 02_bitmap</title>
        <link href="./index.css" rel="stylesheet" />
    </head>
    <body>
        <db id="images">
            <img id="tileset" w="49" l="1078" src="./kenney/monochrome.png"></img>
            <img id="tileset1" w="49" l="1078"  src="./kenney/colored.png"></img>
			<img id="tileset2" w="18" l="198"  src="./kenney/tilemap.png"></img>
        </db>
        <canvas id="bitmap_canvas" width="512" height="512"></canvas>
        <div id="splashscreenloading" class="splashscreen loading"><img id="rice" src="./56.png"></img></div>
    
        <script>
            function main() {
                const canvaselement = document.querySelector("#bitmap_canvas");
                const ctx = canvaselement.getContext("2d");

                const images = {};
                load();
                function load() {
                    const dbimages = document.querySelector("db#images");
                    for (let i = 0; dbimages && i < dbimages.childNodes.length; i++) {
                        const img = dbimages.childNodes[i];
                        const key = img.id;
                        if (!key) {
                            continue;
                        }
                        
                        images[key] = img;
                    }
                }

                let tilesetname = "tileset";
				
				function gettileset() {
					return images[tilesetname];
				}
				
				function gettilesetattribute(key) {
					return Number(gettileset().getAttribute(key) ?? 0);
				}

                const tw = 16;
                const twp = tw + 1;
                const cz = 64;
                const d = (sx, sy, wx, wy) => {
                    ctx.drawImage(gettileset(), sx * (twp), sy * (twp), tw, tw, wx * cz, wy * cz, cz, cz);
                }



                let steps = 0;
                function step() {
					const w = gettilesetattribute("w") || 49;
					const l = gettilesetattribute("l") || 1078;
					
                    _predraw(ctx);
                    steps += 1;
                    const lax = steps % l;
                    const ax = lax % w;
                    const ay = Math.floor(lax / w);

                    const bw = canvaselement.width / cz;
                    const bh = canvaselement.height / cz;
                    const lbx = steps % (bw * bh);
                    const bx = lbx % bw;
                    const by = Math.floor(lbx / bw);
                    d(ax, ay, bx, by)
                }

                const tilesetoptions = ["tileset", "tileset1", "tileset2"];
                let tilesetshiftindex = 0;
                function shift() {
                    tilesetshiftindex = (tilesetshiftindex + 1) % tilesetoptions.length;
                    tilesetname = tilesetoptions[tilesetshiftindex];
                    step();
                }

                function Inputs() {
                    document.addEventListener("mousedown", () => {
                        step();
                    })

                    document.addEventListener("keydown", () => {
                        shift();
                    })
                }

                Inputs();
                step();
            }



            function _predraw(ctx) {
                ctx.msImageSmoothingEnabled = false;
                ctx.mozImageSmoothingEnabled = false;
                ctx.webkitImageSmoothingEnabled = false;
                ctx.imageSmoothingEnabled = false;	
            }

            function onload() {
                return Promise.all(Array.from(document.images).map(img => {
                    if (img.complete)
                        return Promise.resolve(img.naturalHeight !== 0);
                    return new Promise(resolve => {
                        img.addEventListener('load', () => resolve(true));
                        img.addEventListener('error', () => resolve(false));
                    });
                })).then(results => {
                    if (results.every(res => res))
                        console.log('all images loaded successfully');
                    else
                        console.log('some images failed to load, all finished loading');
                });
            }

            onload().then(delay).then(loadingdone).then(main);

            function delay() {
                return new Promise((resolve, reject) => {
                    setTimeout(resolve, 1000);
                })
            }

            function loadingdone() {
                const el = document.querySelector("#splashscreenloading");
                el?.classList.add("hidden");
            }

            function bline(x0, y0, x1, y1, callback) {
                var dx = Math.abs(x1 - x0), sx = x0 < x1 ? 1 : -1;
                var dy = Math.abs(y1 - y0), sy = y0 < y1 ? 1 : -1;
                var err = (dx>dy ? dx : -dy)/2;

                while (callback(x0, y0) !== false) {
                    if (x0 === x1 && y0 === y1) break;
                    var e2 = err;
                    if (e2 > -dx) { err -= dy; x0 += sx; }
                    if (e2 < dy) { err += dx; y0 += sy; }
                }
            }
        </script>
    </body>
</html>